# Kimfe Markdown Convention (KMC) - Guía de Sintaxis | Syntax Guide

_Español | Spanish_

Esta guía detalla la sintaxis completa para crear documentos y plantillas con KMC (Kimfe Markdown Convention).

_English | Inglés_

This guide details the complete syntax for creating documents and templates with KMC (Kimfe Markdown Convention).

## 1. Estructura Básica de Variables | Basic Variable Structure

KMC define tres tipos fundamentales de variables con sintaxis diferenciada:
*KMC defines three fundamental types of variables with differentiated syntax:*

### 1.1 Variables Contextuales | Contextual Variables `[[tipo:nombre]]`

_Español_

Representan datos estáticos o contextuales que se obtienen de fuentes como bases de datos, configuraciones de proyecto, o información de usuario. Estas variables se reemplazan directamente con su valor correspondiente.

_English_

Represent static or contextual data obtained from sources such as databases, project configurations, or user information. These variables are replaced directly with their corresponding value.

```markdown
[[project:nombre_proyecto]]  # Nombre del proyecto desde la base de datos | Project name from database
[[user:email]]               # Email del usuario actual | Current user's email
[[org:nombre_empresa]]       # Nombre de la organización | Organization name
```

#### Tipos de Variables Contextuales Comunes | Common Contextual Variable Types:

| Prefijo | Descripción | Description | Ejemplos | Examples |
|---------|-------------|-------------|----------|----------|
| `project` | Datos del proyecto | Project data | `[[project:id]]`, `[[project:nombre]]` |
| `user` | Datos del usuario | User data | `[[user:email]]`, `[[user:nombre]]` |
| `org` | Datos de organización | Organization data | `[[org:nombre]]`, `[[org:industria]]` |
| `config` | Configuraciones | Configurations | `[[config:idioma]]`, `[[config:zona_horaria]]` |

### 1.2 Variables de Metadata | Metadata Variables `[{tipo:nombre}]`

_Español_

Representan información específica del documento o contenido relacionado, como referencias a la base de conocimiento o números de versión.

_English_

Represent specific information about the document or related content, such as references to the knowledge base or version numbers.

```markdown
[{doc:version}]          # Versión del documento actual | Current document version
[{kb:cita_1}]            # Referencia a un fragmento de la base de conocimiento | Reference to a knowledge base fragment
[{doc:numero_modulo}]    # Número de módulo en un curso | Module number in a course
```

#### Tipos de Variables de Metadata Comunes | Common Metadata Variable Types:

| Prefijo | Descripción | Description | Ejemplos | Examples |
|---------|-------------|-------------|----------|----------|
| `doc` | Metadata del documento | Document metadata | `[{doc:version}]`, `[{doc:autor}]` |
| `kb` | Base de conocimiento | Knowledge base | `[{kb:cita_1}]`, `[{kb:referencia}]` |
| `ref` | Referencias cruzadas | Cross-references | `[{ref:tabla_1}]`, `[{ref:seccion_2}]` |
| `image` | Referencias a imágenes | Image references | `[{image:diagrama}]`, `[{image:logo}]` |

### 1.3 Variables Generativas | Generative Variables `{{categoria:subtipo:nombre}}`

_Español_

Representan contenido generado dinámicamente por IA, APIs, herramientas u otros servicios. Estas variables se procesan en tiempo de renderizado para generar su contenido.

_English_

Represent content dynamically generated by AI, APIs, tools, or other services. These variables are processed at render time to generate their content.

```markdown
{{ai:gpt4:resumen_ejecutivo}}       # Resumen generado por GPT-4 | Summary generated by GPT-4
{{api:weather:pronostico_semanal}}  # Datos de pronóstico de API del tiempo | Weather forecast data from API
{{tool:sentiment:analisis_tweets}}  # Análisis de sentimiento de tweets | Sentiment analysis of tweets
```

#### Categorías Generativas Comunes | Common Generative Categories:

| Categoría | Descripción | Description | Ejemplos | Examples |
|-----------|-------------|-------------|----------|----------|
| `ai` | Modelos de IA | AI models | `{{ai:gpt4:resumen}}`, `{{ai:claude:analisis}}` |
| `api` | APIs externas | External APIs | `{{api:finance:cotizacion}}`, `{{api:weather:clima}}` |
| `tool` | Herramientas/algoritmos | Tools/algorithms | `{{tool:ocr:texto}}`, `{{tool:sentiment:score}}` |
| `calc` | Cálculos/fórmulas | Calculations/formulas | `{{calc:financiero:roi}}`, `{{calc:stats:promedio}}` |
| `mcp` | Model Context Protocol | Model Context Protocol | `{{mcp:blockchain:verificacion}}`, `{{mcp:db:consulta}}` |

## 2. Instrucciones para Variables Generativas | Instructions for Generative Variables

_Español_

Las instrucciones para variables generativas se definen en comentarios HTML.

_English_

Instructions for generative variables are defined in HTML comments.

### 2.1 Estructura de Comentarios de Instrucciones | Instruction Comment Structure

```markdown
<!-- TIPO_INSTRUCCION FOR {{variable}}: 
Contenido de la instrucción 
-->
```

Tipos de instrucciones comunes | Common instruction types:

| Tipo Instrucción | Uso | Use | Ejemplo | Example |
|------------------|-----|-----|---------|---------|
| `AI_PROMPT` | Instrucciones para modelos de IA | Instructions for AI models | `<!-- AI_PROMPT FOR {{ai:gpt4:resumen}}: ... -->` |
| `API_SOURCE` | Configuración para llamadas API | Configuration for API calls | `<!-- API_SOURCE: https://api.example.com/v1/data -->` |
| `TOOL_CONFIG` | Configuración para herramientas | Configuration for tools | `<!-- TOOL_CONFIG FOR {{tool:ocr:texto}}: idioma=es -->` |
| `CALC_FORMULA` | Fórmulas para cálculos | Formulas for calculations | `<!-- CALC_FORMULA: (valor1 + valor2) / 2 -->` |

### 2.2 Definición de Prompts para Variables de IA | Prompt Definition for AI Variables

_Español_

Los prompts para variables generativas de IA se definen usando la estructura `AI_PROMPT`:

_English_

Prompts for AI generative variables are defined using the `AI_PROMPT` structure:

```markdown
<!-- AI_PROMPT FOR {{ai:gpt4:resumen}}:
Genera un resumen de este proyecto basándote en la información contextual.
Incluye:
- Alcance del proyecto
- Objetivos principales
- Tecnologías utilizadas
Extensión: máximo 200 palabras.
-->
```

### 2.3 Definiciones Integradas de Variables (KMC_DEFINITION) | Integrated Variable Definitions

_Español_

Esta sintaxis es fundamental para KMC y establece una regla clara: para que una variable de metadata (ej. `[{doc:mi_variable}]`) sea renderizada con contenido generado, **debe existir como un placeholder en el cuerpo del documento Y además tener un bloque `KMC_DEFINITION` asociado.**

El bloque `KMC_DEFINITION FOR [{doc:mi_variable}]` no inserta contenido directamente en su propia ubicación. En su lugar, define cómo se generará el contenido para todas las instancias del placeholder `[{doc:mi_variable}]` que se encuentren en el documento. Esta definición es global para el documento una vez declarada y puede ser capturada por el SDK para su reutilización.

#### Estructura de KMC_DEFINITION | KMC_DEFINITION Structure

```markdown
<!-- KMC_DEFINITION FOR [{tipo:nombre}]:
GENERATIVE_SOURCE = {{categoria:subtipo:nombre}}
PROMPT = "Instrucciones para generar el contenido"
FORMAT = "formato/tipo; parámetros_adicionales"
-->
```

Donde | Where:

- `[{tipo:nombre}]` es la variable de metadata que se va a definir | is the metadata variable to be defined
- `{{categoria:subtipo:nombre}}` es la variable generativa que proporcionará el contenido | is the generative variable that will provide the content
- `PROMPT` contiene las instrucciones para generar el contenido | contains instructions to generate content
- `FORMAT` (opcional) especifica el formato deseado para la salida | (optional) specifies the desired output format

#### Ejemplo Completo | Complete Example

```markdown
<!-- KMC_DEFINITION FOR [{doc:objetivos_de_aprendizaje}]:
GENERATIVE_SOURCE = {{ai:gpt4:extract_objectives}}
PROMPT = "Extrae un listado de objetivos y resultados de aprendizaje a partir de [{kb:contenido}]. Se definen tantos RA y OA como sean necesarios para cubrir los objetivos de aprendizaje"
FORMAT = "markdown; bullet_list"
-->

## Objetivos y Resultados de Aprendizaje

[{doc:objetivos_de_aprendizaje}]
```

#### Reglas de Renderizado | Rendering Rules

**Regla fundamental:**
- Las variables contextuales (`[[tipo:nombre]]`) y de metadata (`[{tipo:nombre}]`) son las únicas que se renderizan en el documento final.
- Las variables generativas (`{{categoria:subtipo:nombre}}`) **nunca** se renderizan directamente en el documento. Su función es servir como fuente de datos o función generadora, y deben ser referenciadas únicamente dentro de bloques de definición `<!-- KMC_DEFINITION ... -->`.
- Para que una variable de metadata (ej. `[{doc:mi_variable}]`) sea renderizada con contenido generado, debe:
  1. Existir como placeholder en el cuerpo del documento.
  2. Tener un bloque `KMC_DEFINITION` que la asocie a una variable generativa y un prompt.
- El bloque `KMC_DEFINITION` permite procesar la variable de metadata usando la variable generativa (función) y el prompt asociado.

_Ejemplo práctico:_

```markdown
<!-- KMC_DEFINITION FOR [{doc:resumen_ejecutivo}]:
GENERATIVE_SOURCE = {{ai:gpt4:resumen}}
PROMPT = "Genera un resumen ejecutivo del proyecto [[project:nombre]]"
FORMAT = "markdown"
-->

## Resumen Ejecutivo
[{doc:resumen_ejecutivo}]
```

En este ejemplo, `[{doc:resumen_ejecutivo}]` será reemplazada por el contenido generado por la función `{{ai:gpt4:resumen}}` usando el prompt especificado. La variable generativa nunca aparece en el documento final.

## 3. Encadenamiento de Variables | Variable Chaining

_Español_

KMC permite encadenar variables para crear flujos de trabajo complejos donde el resultado de una variable sirve como entrada para otra.

_English_

KMC allows chaining variables to create complex workflows where the result of one variable serves as input for another.

### 3.1 Uso de Variables en Prompts | Using Variables in Prompts

_Español_

Se pueden referenciar otras variables dentro de los prompts:

_English_

Other variables can be referenced within prompts:

```markdown
<!-- KMC_DEFINITION FOR [{doc:recomendaciones}]:
GENERATIVE_SOURCE = {{ai:gpt4:generate_recommendations}}
PROMPT = "Basándote en el análisis [{doc:analisis_datos}], genera recomendaciones específicas para el proyecto [[project:nombre]]."
FORMAT = "markdown; bullet_list"
-->

## Recomendaciones
[{doc:recomendaciones}]
```

### 3.2 Dependencias entre Variables | Dependencies between Variables

_Español_

Al encadenar variables, se establece un orden implícito de resolución:

_English_

When chaining variables, an implicit resolution order is established:

```markdown
<!-- KMC_DEFINITION FOR [{doc:analisis_datos}]:
GENERATIVE_SOURCE = {{ai:gpt4:analyze_data}}
PROMPT = "Analiza los siguientes datos del proyecto: [[project:datos_clave]]"
-->

<!-- KMC_DEFINITION FOR [{doc:recomendaciones}]:
GENERATIVE_SOURCE = {{ai:gpt4:generate_recommendations}}
PROMPT = "Basándote en el análisis [{doc:analisis_datos}], genera recomendaciones."
-->
```

En este ejemplo, `[{doc:analisis_datos}]` debe resolverse antes que `[{doc:recomendaciones}]` porque la segunda depende de la primera.

In this example, `[{doc:analisis_datos}]` must be resolved before `[{doc:recomendaciones}]` because the second depends on the first.

## 4. Formatos de Salida | Output Formats

_Español_

El atributo `FORMAT` en las definiciones KMC_DEFINITION permite especificar el formato deseado para la salida.

_English_

The `FORMAT` attribute in KMC_DEFINITION allows specifying the desired output format.

### 4.1 Sintaxis de Formato | Format Syntax

```
FORMAT = "tipo/subtipo; parámetro1=valor1; parámetro2=valor2"
```

### 4.2 Formatos Comunes | Common Formats

| Formato | Descripción | Description | Ejemplo | Example |
|---------|-------------|-------------|---------|---------|
| `text/plain` | Texto sin formato | Plain text | `FORMAT = "text/plain; max_length=100"` |
| `markdown` | Contenido Markdown | Markdown content | `FORMAT = "markdown; bullet_list"` |
| `json` | Estructura JSON | JSON structure | `FORMAT = "json; schema=schema1"` |
| `html` | Contenido HTML | HTML content | `FORMAT = "html; clean=true"` |
| `image/png` | Imagen PNG | PNG image | `FORMAT = "image/png; width=800; height=600"` |

### 4.3 Ejemplos de Uso | Usage Examples

```markdown
<!-- KMC_DEFINITION FOR [{doc:tabla_datos}]:
GENERATIVE_SOURCE = {{ai:gpt4:extract_data}}
PROMPT = "Extrae los datos principales del proyecto en formato tabular"
FORMAT = "markdown; table; headers=true"
-->
```

```markdown
<!-- KMC_DEFINITION FOR [{image:diagrama_flujo}]:
GENERATIVE_SOURCE = {{ai:dalle:generation}}
PROMPT = "Un diagrama de flujo para el proceso [[project:proceso_principal]]"
FORMAT = "image/png; width=1024; height=768; style=technical_diagram"
-->
```

## 5. Integración con Sistemas Externos | Integration with External Systems

_Español_

KMC está diseñado para integrarse con diversos sistemas externos, como LlamaIndex, APIs y otras fuentes de datos.

_English_

KMC is designed to integrate with various external systems, such as LlamaIndex, APIs, and other data sources.

### 5.1 Integración con LlamaIndex | LlamaIndex Integration

```markdown
<!-- KMC_DEFINITION FOR [{kb:respuesta_técnica}]:
GENERATIVE_SOURCE = {{mcp:llamaindex:query}}
PROMPT = "¿Cómo funciona el mecanismo de cache en el proyecto [[project:nombre]]?"
FORMAT = "markdown; max_tokens=500"
-->

## Detalles Técnicos
[{kb:respuesta_técnica}]
```

### 5.2 Integración con APIs | API Integration

```markdown
<!-- KMC_DEFINITION FOR [{doc:datos_mercado}]:
GENERATIVE_SOURCE = {{api:finance:market_data}}
PROMPT = "Obtener datos de mercado para [[org:sector]] en el último trimestre"
FORMAT = "markdown; table"
-->

## Análisis de Mercado
[{doc:datos_mercado}]
```

## 6. Interoperabilidad | Interoperability

_Español_

KMC se puede utilizar en diferentes contextos, desde documentos Markdown estáticos hasta aplicaciones web dinámicas.

_English_

KMC can be used in different contexts, from static Markdown documents to dynamic web applications.

### 6.1 Uso en Documentos Estáticos | Use in Static Documents

```markdown
# Informe de Proyecto: [[project:nombre]]

## Resumen Ejecutivo
[{doc:resumen_ejecutivo}]

## Análisis de Datos
[{doc:analisis_datos}]
```

### 6.2 Integración en Aplicaciones Web | Integration in Web Applications

```python
from kmc_parser import KMCParser
from flask import Flask, render_template_string

app = Flask(__name__)

@app.route('/project/<project_id>')
def project_report(project_id):
    # Cargar plantilla KMC
    with open('templates/report_template.md', 'r') as f:
        template = f.read()
    
    # Configurar parser con datos específicos del proyecto
    parser = KMCParser()
    parser.register_context_handler("project", lambda var: get_project_data(project_id, var))
    
    # Renderizar la plantilla
    rendered_content = parser.process_document(markdown_content=template)
    
    # Convertir Markdown a HTML para la web
    html_content = convert_markdown_to_html(rendered_content)
    
    return render_template_string(html_content)
```

## 7. Mejores Prácticas | Best Practices

1. **Nombrado de Variables | Variable Naming:**
   - Usa `snake_case` para todas las variables | Use `snake_case` for all variables
   - Nombres descriptivos pero concisos | Descriptive but concise names
   - Mantén consistencia en toda la plantilla | Maintain consistency throughout the template

2. **Prompts Efectivos | Effective Prompts:**
   - Sé específico sobre el formato deseado | Be specific about the desired format
   - Incluye contexto relevante | Include relevant context
   - Establece límites claros (longitud, estilo, tono) | Set clear limits (length, style, tone)

3. **Estructura del Documento | Document Structure:**
   - Usa encabezados jerárquicos (# para título, ## para secciones principales) | Use hierarchical headings (# for title, ## for main sections)
   - Agrupa bloques KMC_DEFINITION relacionados | Group related KMC_DEFINITION blocks
   - Coloca las definiciones KMC_DEFINITION cerca del principio del documento o cerca de donde se utiliza por primera vez el placeholder | Place KMC_DEFINITION blocks near the beginning of the document or near where the placeholder is first used

4. **Declaración y Definición con `KMC_DEFINITION` (Regla Fundamental):**
   - _Español_: Para que una variable de metadata (ej. `[{doc:mi_contenido_dinamico}]`) muestre contenido generado, primero debe ser **declarada como un placeholder** en la ubicación deseada dentro del cuerpo del documento. Segundo, debe existir un bloque `<!-- KMC_DEFINITION FOR [{doc:mi_contenido_dinamico}]: ... -->` que defina su fuente generativa y prompt. Esta definición es global para el documento y el SDK puede capturarl