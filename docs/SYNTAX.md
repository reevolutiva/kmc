# Kimfe Markdown Convention (KMC) - Guía de Sintaxis | Syntax Guide

_Español | Spanish_

Esta guía detalla la sintaxis completa para crear documentos y plantillas con KMC (Kimfe Markdown Convention).

_English | Inglés_

This guide details the complete syntax for creating documents and templates with KMC (Kimfe Markdown Convention).

## 1. Estructura Básica de Variables | Basic Variable Structure

KMC define tres tipos fundamentales de variables con sintaxis diferenciada:
*KMC defines three fundamental types of variables with differentiated syntax:*

### 1.1 Variables Contextuales | Contextual Variables `[[tipo:nombre]]`

_Español_

Representan datos estáticos o contextuales que se obtienen de fuentes como bases de datos, configuraciones de proyecto, o información de usuario. Estas variables se reemplazan directamente con su valor correspondiente.

_English_

Represent static or contextual data obtained from sources such as databases, project configurations, or user information. These variables are replaced directly with their corresponding value.

```markdown
[[project:nombre_proyecto]]  # Nombre del proyecto desde la base de datos | Project name from database
[[user:email]]               # Email del usuario actual | Current user's email
[[org:nombre_empresa]]       # Nombre de la organización | Organization name
```

#### Tipos de Variables Contextuales Comunes | Common Contextual Variable Types:

| Prefijo | Descripción | Description | Ejemplos | Examples |
|---------|-------------|-------------|----------|----------|
| `project` | Datos del proyecto | Project data | `[[project:id]]`, `[[project:nombre]]` |
| `user` | Datos del usuario | User data | `[[user:email]]`, `[[user:nombre]]` |
| `org` | Datos de organización | Organization data | `[[org:nombre]]`, `[[org:industria]]` |
| `config` | Configuraciones | Configurations | `[[config:idioma]]`, `[[config:zona_horaria]]` |

### 1.2 Variables de Metadata | Metadata Variables `[{tipo:nombre}]`

_Español_

Representan información específica del documento o contenido relacionado, como referencias a la base de conocimiento o números de versión.

_English_

Represent specific information about the document or related content, such as references to the knowledge base or version numbers.

```markdown
[{doc:version}]          # Versión del documento actual | Current document version
[{kb:cita_1}]            # Referencia a un fragmento de la base de conocimiento | Reference to a knowledge base fragment
[{doc:numero_modulo}]    # Número de módulo en un curso | Module number in a course
```

#### Tipos de Variables de Metadata Comunes | Common Metadata Variable Types:

| Prefijo | Descripción | Description | Ejemplos | Examples |
|---------|-------------|-------------|----------|----------|
| `doc` | Metadata del documento | Document metadata | `[{doc:version}]`, `[{doc:autor}]` |
| `kb` | Base de conocimiento | Knowledge base | `[{kb:cita_1}]`, `[{kb:referencia}]` |
| `ref` | Referencias cruzadas | Cross-references | `[{ref:tabla_1}]`, `[{ref:seccion_2}]` |

### 1.3 Variables Generativas | Generative Variables `{{categoria:subtipo:nombre}}`

_Español_

Representan funciones que, integradas con variables de metadata, permiten poblar de manera dinámica y precisa todo el contenido del documento basado en las instrucciones del usuario.

_English_

Represent functions that, when combined with metadata variables, dynamically and accurately populate the entire document content according to user instructions.

```markdown
{{ai:gpt4:resumen_ejecutivo}}       # Resumen generado por GPT-4 | Summary generated by GPT-4
{{api:weather:pronostico_semanal}}  # Datos de pronóstico de API del tiempo | Weather forecast data from API
{{tool:sentiment:analisis_tweets}}  # Análisis de sentimiento de tweets | Sentiment analysis of tweets
```

#### Categorías Generativas Comunes | Common Generative Categories:

| Categoría | Descripción | Description | Ejemplos | Examples |
|-----------|-------------|-------------|----------|----------|
| `ai` | Modelos de IA | AI models | `{{ai:gpt4:resumen}}`, `{{ai:claude:analisis}}` |
| `api` | APIs externas | External APIs | `{{api:finance:cotizacion}}`, `{{api:weather:clima}}` |
| `tool` | Herramientas/algoritmos | Tools/algorithms | `{{tool:ocr:texto}}`, `{{tool:sentiment:score}}` |
| `calc` | Cálculos/fórmulas | Calculations/formulas | `{{calc:financiero:roi}}`, `{{calc:stats:promedio}}` |
| `mcp` | Model Context Protocol | Model Context Protocol | `{{mcp:blockchain:verificacion}}`, `{{mcp:db:consulta}}` |

## 2. Instrucciones para Variables Generativas | Instructions for Generative Variables

_Español_

Las instrucciones para variables generativas se definen en comentarios HTML.

_English_

Instructions for generative variables are defined in HTML comments.

### 2.1 Estructura de Comentarios de Instrucciones | Instruction Comment Structure

```markdown
<!-- TIPO_INSTRUCCION FOR {{variable}}: 
Contenido de la instrucción 
-->
```

Tipos de instrucciones comunes | Common instruction types:

| Tipo Instrucción | Uso | Use | Ejemplo | Example |
|------------------|-----|-----|---------|---------|
| `AI_PROMPT` | Instrucciones para modelos de IA | Instructions for AI models | `<!-- AI_PROMPT FOR {{ai:gpt4:resumen}}: ... -->` |
| `API_SOURCE` | Configuración para llamadas API | Configuration for API calls | `<!-- API_SOURCE: https://api.example.com/v1/data -->` |
| `TOOL_CONFIG` | Configuración para herramientas | Configuration for tools | `<!-- TOOL_CONFIG FOR {{tool:ocr:texto}}: idioma=es -->` |
| `CALC_FORMULA` | Fórmulas para cálculos | Formulas for calculations | `<!-- CALC_FORMULA: (valor1 + valor2) / 2 -->` |

### 2.3 Definiciones Integradas de Variables (KMC_DEFINITION) | Integrated Variable Definitions

_Español_

Esta sintaxis es fundamental para KMC y establece una regla clara: para que una variable de metadata (ej. `[{doc:mi_variable}]`) sea renderizada con contenido generado, **debe existir como un placeholder en el cuerpo del documento Y además tener un bloque `KMC_DEFINITION` asociado.**

El bloque `KMC_DEFINITION FOR [{doc:mi_variable}]` no inserta contenido directamente en su propia ubicación. En su lugar, define cómo se generará el contenido para todas las instancias del placeholder `[{doc:mi_variable}]` que se encuentren en el documento.

La estructura básica de un bloque `KMC_DEFINITION` es la siguiente:

```markdown
<!-- KMC_DEFINITION FOR [{doc:variable_name}]:
GENERATIVE_SOURCE = {{categoria:subtipo:nombre_funcion_generativa}}
PROMPT = "Instrucciones detalladas para la fuente generativa. Puede incluir otras variables [[contextuales]] o [{de_metadata}] si el sistema de procesamiento las resuelve en orden."
# Otros parámetros opcionales específicos de la fuente generativa pueden ir aquí, por ejemplo:
# FORMAT = "markdown_list" (si la fuente generativa lo soporta)
# API_ENDPOINT = "/data" (si GENERATIVE_SOURCE es de tipo api)
-->
```

**Claves Fundamentales en `KMC_DEFINITION`:**
-   `GENERATIVE_SOURCE`: **Obligatoria.** Especifica el motor o función que generará el contenido (ej. `{{ai:gpt4:crear_texto}}`, `{{api:serviciodatos:obtener_item}}`).
-   `PROMPT`: **Obligatoria.** Contiene las instrucciones detalladas para la `GENERATIVE_SOURCE`.

_English_

This syntax is fundamental to KMC and establishes a clear rule: for a metadata variable (e.g., `[{doc:my_variable}]`) to be rendered with generated content, **it must exist as a placeholder in the document body AND also have an associated `KMC_DEFINITION` block.**

The `KMC_DEFINITION FOR [{doc:my_variable}]` block does not directly insert content at its own location. Instead, it defines how content will be generated for all instances of the `[{doc:my_variable}]` placeholder found within the document.

The basic structure of a `KMC_DEFINITION` block is as follows:

```markdown
<!-- KMC_DEFINITION FOR [{doc:variable_name}]:
GENERATIVE_SOURCE = {{category:subtype:generative_function_name}}
PROMPT = "Detailed instructions for the generative source. May include other [[contextual]] or [{metadata}] variables if the processing system resolves them in order."
# Other optional parameters specific to the generative source can go here, for example:
# FORMAT = "markdown_list" (if supported by the generative source)
# API_ENDPOINT = "/data" (if GENERATIVE_SOURCE is an api type)
-->
```

**Fundamental Keys in `KMC_DEFINITION`:**
-   `GENERATIVE_SOURCE`: **Mandatory.** Specifies the engine or function that will generate the content (e.g., `{{ai:gpt4:create_text}}`, `{{api:dataservice:get_item}}`).
-   `PROMPT`: **Mandatory.** Contains the detailed instructions for the `GENERATIVE_SOURCE`.

## 3. Modelo de Procesamiento KMC (Dos Capas) | KMC Processing Model (Two-Layer)

_Español_

KMC opera con un modelo de dos capas para transformar un documento `.kmc.md` en un documento final:

1.  **Capa 1: Motor de Parseo y Pre-procesamiento KMC (Sistema Automatizado):**
    *   Analiza el documento KMC, identificando todas las variables: `[[contextuales]]`, `[{de_metadata}]`, y `{{generativas}}`.
    *   Resuelve las variables `[[contextuales]]` obteniendo sus valores de fuentes externas (bases de datos, configuraciones, etc.).
    *   Para cada variable `[{de_metadata}]`, lee su bloque `KMC_DEFINITION` asociado.
    *   La `GENERATIVE_SOURCE` indica al motor qué función, API o sub-proceso LLM invocar. El sistema puede usar un registro interno para mapear estas fuentes a ejecutables concretos.
    *   El `PROMPT` (y otros parámetros opcionales) se pasan como instrucciones a la `GENERATIVE_SOURCE`.
    *   Prepara el documento para la Capa 2, asegurando que toda la información y las instrucciones estén estructuradas. Si una `GENERATIVE_SOURCE` no es un LLM (ej. una API), esta capa podría resolverla directamente.

2.  **Capa 2: LLM de Generación de Contenido (Guiado por Prompt Específico):**
    *   Recibe el documento (parcialmente) procesado de la Capa 1.
    *   Su tarea principal es ejecutar las tareas generativas que requieren un LLM. Para los `KMC_DEFINITION` que apuntan a una `GENERATIVE_SOURCE` basada en LLM (ej. `{{ai:gpt4:redactar_seccion}}`), este LLM de Capa 2 utiliza el `PROMPT` para generar el contenido.
    *   Reemplaza los placeholders `[{de_metadata}]` con el contenido generado.
    *   El procesamiento idealmente es de arriba hacia abajo, permitiendo que el contenido generado para una variable esté disponible como contexto para las siguientes.

_English_

KMC operates on a two-layer model to transform a `.kmc.md` document into a final document:

1.  **Layer 1: KMC Parsing and Pre-processing Engine (Automated System):**
    *   Parses the KMC document, identifying all variables: `[[contextual]]`, `[{metadata}]`, and `{{generative}}`.
    *   Resolves `[[contextual]]` variables by fetching their values from external sources (databases, configurations, etc.).
    *   For each `[{metadata}]` variable, it reads its associated `KMC_DEFINITION` block.
    *   The `GENERATIVE_SOURCE` tells the engine which function, API, or LLM sub-process to invoke. The system may use an internal registry to map these sources to concrete executables.
    *   The `PROMPT` (and other optional parameters) are passed as instructions to the `GENERATIVE_SOURCE`.
    *   Prepares the document for Layer 2, ensuring all information and instructions are structured. If a `GENERATIVE_SOURCE` is not LLM-based (e.g., an API call), this layer might resolve it directly.

2.  **Layer 2: Content Generation LLM (Guided by Specific Prompt):**
    *   Receives the (partially) processed document from Layer 1.
    *   Its main task is to execute generative tasks that require an LLM. For `KMC_DEFINITION`s pointing to an LLM-based `GENERATIVE_SOURCE` (e.g., `{{ai:gpt4:draft_section}}`), this Layer 2 LLM uses the `PROMPT` to generate the content.
    *   Replaces the `[{metadata}]` placeholders with the generated content.
    *   Processing is ideally top-down, allowing generated content for one variable to be available as context for subsequent ones.


## 4. Declaración de Todas las Variables | Declaration of All Variables
_Español_
Todas las variables contextuales `[[tipo:nombre]]` y de metadata `[{tipo:nombre}]` que se pretendan utilizar o poblar deben ser declaradas explícitamente en el cuerpo del documento KMC. Esto asegura que el motor de parseo y los LLMs subsecuentes tengan conocimiento de todas las piezas de información que componen el documento.

_English_
All contextual `[[type:name]]` and metadata `[{type:name}]` variables intended for use or population must be explicitly declared within the body of the KMC document. This ensures that the parsing engine and subsequent LLMs are aware of all pieces of information that make up the document.


## 8. Mejores Prácticas | Best Practices 

1. **Nombrado de Variables | Variable Naming:**
   - Usa `snake_case` para todas las variables | Use `snake_case` for all variables
   - Nombres descriptivos pero concisos | Descriptive but concise names
   - Mantén consistencia en toda la plantilla | Maintain consistency throughout the template

2. **Prompts Efectivos | Effective Prompts:**
   - Sé específico sobre el formato deseado | Be specific about the desired format
   - Incluye contexto relevante | Include relevant context
   - Establece límites claros (longitud, estilo, tono) | Set clear limits (length, style, tone)

3. **Estructura del Documento | Document Structure:**
   - Usa encabezados jerárquicos (# para título, ## para secciones principales) | Use hierarchical headings (# for title, ## for main sections)
   - Agrupa bloques KMC_DEFINITION relacionados | Group related KMC_DEFINITION blocks
   - Coloca las definiciones KMC_DEFINITION cerca del principio del documento o cerca de donde se utiliza por primera vez el placeholder | Place KMC_DEFINITION blocks near the beginning of the document or near where the placeholder is first used

4. **Declaración y Definición con `KMC_DEFINITION` (Regla Fundamental):**
   - _Español_: Para que una variable de metadata (ej. `[{doc:mi_contenido_dinamico}]`) muestre contenido generado, primero debe ser **declarada como un placeholder** en la ubicación deseada dentro del cuerpo del documento. Segundo, debe existir un bloque `<!-- KMC_DEFINITION FOR [{doc:mi_contenido_dinamico}]: ... -->` que defina su fuente generativa y prompt. Esta definición es global para el documento y el SDK puede capturarla para su reutilización.
   
   - _English_: For a metadata variable (e.g., `[{doc:my_dynamic_content}]`) to display generated content, it must first be **declared as a placeholder** at the desired location within the document body. Second, there must be a `<!-- KMC_DEFINITION FOR [{doc:my_dynamic_content}]: ... -->` block that defines its generative source and prompt. This definition is global for the document and the SDK can capture it for reuse.

5. **Reglas de Renderizado | Rendering Rules:**
   - _Español_: Recuerda la regla fundamental: las variables con formato `[{tipo:nombre}]` se renderizan con su contenido, mientras que las variables con formato `{{categoria:subtipo:nombre}}` NUNCA se renderizan directamente (solo se usan como fuentes generativas).
   
   - _English_: Remember the fundamental rule: variables with format `[{type:name}]` are rendered with their content, while variables with format `{{category:subtype:name}}` are NEVER rendered directly (they are only used as generative sources).

6. **Reutilización de Variables | Variable Reuse:**
   - Define variables comunes al inicio del documento | Define common variables at the beginning of the document
   - Reutiliza las mismas variables para contenido similar | Reuse the same variables for similar content
   - Aprovecha la capacidad del SDK para capturar definiciones | Take advantage of the SDK's ability to capture definitions